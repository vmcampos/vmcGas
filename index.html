<!doctype html>
<html>
	<!-- Simple JavaScript project to capture fuel fill up info, and save to a PouchDB database by vmcampos.com -->
	<head>
		<meta charset="utf-8">
		<title>VmC Mileage</title>
		<!-- The JavaScript database that syncs. Found at http://pouchdb.com. Related to CouchDB. -->
		<script src="pouchdb-3.1.0.min.js"></script>
		<script>
			// Create PouchDB database
			var db = new PouchDB("gasDB00",
						function(pdberr, pdbgood) {
							if(!pdberr) {
								console.log("Successfully created PouchDB");
								db.info(function(infoerr, infoinf) { 
									if(!infoerr) {
										console.log(infoinf);
									} else {
										console.log(infoerr);
									};
								});
							} else {
								console.log("Error creating PouchDB");
								console.log(pdberr);
							};
						}
			);
			
			// Function to clear user input fields
			function clearFields() {
				document.getElementById("currOdo").value = "";
				document.getElementById("currGal").value = "";
				document.getElementById("currCost").value = "";
			};
			
			// Function to save a FillUp, gathered from user input
			function saveFillUp() { 
				var theOdo = document.getElementById("currOdo").value;
				var theGal = Math.round(100 * (document.getElementById("currGal").value)) / 100;
				var theCost = document.getElementById("currCost").value;
				
				// Create a new PouchDB Document with all the user-generated data, plus Date()
				var aFillup = {
					_id: new Date().toJSON(),
					odo: theOdo,
					gal: theGal,
					cost: theCost
				};
				
				// Put the Document into the PouchDB 
				db.put(aFillup, 
					function (fillerror, fillresult) {
						if(!fillerror) {
							console.log(fillresult);
							clearFields();
							showFillUps();	// Display input data on-screen, in a table.
						} else { 
							console.log(fillerror);
						}
					}
				);
			};

			// Function to get all the Documents that were added to the PouchDB database
			function showFillUps() {
				db.allDocs(
					{include_docs: true, descending: true},
					function (showerr, doc) {
						if(!showerr) {
							console.log(doc);
							showTableOfFillUps(doc.rows);
						} else {
							console.log(showerr);
						};
					}
				);
			};
			
			// Function to build the Table and show all the data in the PouchDB database
			function showTableOfFillUps(data) {
				var div = document.getElementById("fillupTable");
				var str = "<table border='1' style='width: 100%; margin-top: 25px; table-layout: fixed;'><tr><th>Date</th><th>Odo</th><th>Gallons</th><th>Cost</th></tr>";
				for(var i = 0; i < data.length; i++) {
					str += "<tr><td style='text-wrap: normal; word-wrap: break-word;'>" + data[i].doc._id +
					"</td><td style='text-wrap: normal; word-wrap: break-word;'>" + addCommas(data[i].doc.odo) +
					"</td><td style='text-wrap: normal; word-wrap: break-word;'>" + data[i].doc.gal + 
					"</td><td style='text-wrap: normal; word-wrap: break-word;'>$" + data[i].doc.cost + 
					"</td></tr>";
				};
				str += "</table> <br>";
				div.innerHTML = str;
			};
			
			// Function to calculate Latest Miles Per Gallon
			function getLastMPG() {
				db.allDocs(
					{include_docs: true, ascending: true},
					function (err, doc) {
						var lastOdo = doc.rows[doc.rows.length - 1].doc.odo;
						var secondLastOdo = doc.rows[doc.rows.length - 2].doc.odo;
						var lastGal = doc.rows[doc.rows.length - 1].doc.gal;
						var mpg = Math.round(100 * ((lastOdo - secondLastOdo) / lastGal)) / 100;
						if(!err) {
							console.log("Last Odo: " + lastOdo + "\nSecond-Last Odo: " + secondLastOdo + "\nLast Gallons: " + lastGal + "\nMPG: " + mpg);
							document.getElementById("lastStats").innerHTML = "<p>Last Odo: " + addCommas(lastOdo) + "<br>Second-Last Odo: " + addCommas(secondLastOdo) + "<br>Last Gallons: " + lastGal + "</p>";
							document.getElementById("lastStats").innerHTML += "Last MPG: " + mpg;
						} else {
							console.log(err);
						}
					}
				);
			};
			
			// Function to calculate Averages {WORK IN PROGRESS}
			function getAverages() {
				db.allDocs(
					{include_docs: true, ascending: true},
					function (err, doc) {
						if(!err) {
							// This section seems to work well. Used to get, calculate, and display Total Gallons, Average Gallons, Total Cost, and Average Cost
							var totalGal = 0;
							var avgGal = 0;
							var totalCost = 0;
							var avgCost = 0;
							for(var j = 0; j < doc.rows.length; j++) {
								totalGal += Number(doc.rows[j].doc.gal);
								totalCost += Number(doc.rows[j].doc.cost);
							};
							avgGal = Math.round(100 * (totalGal / doc.rows.length)) / 100;
							avgCost = Math.round(100 * (totalCost / doc.rows.length)) / 100;
							console.log("Total Gallons: " + totalGal + " || Avg Gallons: " + avgGal);
							console.log("Total Cost: " + totalCost + "||  Avg Cost: " + avgCost); 
							document.getElementById("avgStats").innerHTML = "<p>Total Gallons: " + totalGal + "<br>Average Gallons: " + avgGal;
							document.getElementById("avgStats").innerHTML += "Total Cost: $" + totalCost + "<br>Average Cost: $" + avgCost;
							// End of Total Gallons, Average Gallons, Total Cost, and Average Cost
							
							// This is for calculating average Miles Per Gallon from all the data input
							var lastOdo = 0;
							var lastGal = 0;
							var secondLastOdo = 0;
							var totalMPG = 0;
							var avgMPG = 0;
							for(var k = doc.rows.length; k > 0; k--) {
								lastOdo = Number(doc.rows[k - 1].doc.odo);
								lastGal = Number(doc.rows[k - 1].doc.gal);
								if (k > 1) { // OH SNAP. Seems to solve going past the array. But last MPG is zero. Maybe ignore it?
									secondLastOdo = Number(doc.rows[k - 2].doc.odo); 
								};
								var mpg = Math.round(100 * ((lastOdo - secondLastOdo) / lastGal)) / 100;
								totalMPG += mpg;
								if (mpg > 0) {
									console.log("Last: " + lastOdo + " || secondLast: " + secondLastOdo + " || lastGal: " + lastGal + " || MPG: " + mpg);
								};
							} 
							avgMPG = (totalMPG / (doc.rows.length - 1));
							console.log("Total MPG: " + totalMPG);
							console.log("Avg MPG: " + avgMPG);
							document.getElementById("avgStats").innerHTML += "<p><strong>Average Miles Per Gallon: " + avgMPG + "</strong></p>";
							// End of calculating average Miles Per Gallon
						} else {
							console.log("Error getting the Documents from the database: " + err);
						};
					}
				);
			};
			
			// Function to add commas and periods to numbers. Found at http://www.mredkj.com/javascript/nfbasic.html
			function addCommas(nStr) {
				nStr += '';
				x = nStr.split('.');
				x1 = x[0];
				x2 = x.length > 1 ? '.' + x[1] : '';
				var rgx = /(\d+)(\d{3})/;
				while (rgx.test(x1)) {
					x1 = x1.replace(rgx, '$1' + ',' + '$2');
				}
				return x1 + x2;
			};
		</script>
	</head>
	<body>
		<!-- Inputs (Number types) to collect fill up data -->
		<label for="inputOdo">Current Odometer</label><input type="number" name="inputOdo" id="currOdo">
		<label for="inputGal">Current Gallons</label><input type="number" step="0.001" name="inputGal" id="currGal">
		<label for="inputCost">Fillup Cost</label><input type="number" step="0.01" name="inputCost" id="currCost">
		<input type="button" value="Go" id="btnGo" onclick="saveFillUp();">
		<input type="button" value="Show FillUPs" onclick="showFillUps();">
		<!-- <input type="button" value="Get Last MPG" onclick="getLastMPG();"> (Just for checking if things are working okay.)-->
		<input type="button" value="Get Avg MPG" onclick="getAverages();">
		
		<!-- Divs to display various results -->
		<div id="fillupTable"></div>
		<div id="lastStats"></div>
		<div id="avgStats"></div>
	</body>
</html>