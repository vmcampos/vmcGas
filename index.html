<!doctype html>
<html>
	<!-- Simple JavaScript/jQuery project to capture fuel fill up info, and save to a PouchDB database by vmcampos.com -->
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height">
		<title>VmC Mileage</title>
	</head>
	<body>
		<!-- Inputs (Number types) to collect fill up data -->
		<label for="inputOdo">Current Odometer </label><input type="number" name="inputOdo" placeholder="123,456" id="currOdo">
		<label for="inputGal">Current Gallons </label><input type="number" step="0.001" name="inputGal" placeholder="14.187" id="currGal">
		<label for="inputCost">Fillup Cost </label><input type="number" step="0.01" name="inputCost" placeholder="48.25" id="currCost">
		<label for="inputNote">Notes </label><input type="text" name="inputNote" placeholder="Arco station" id="currNote">
		<input type="button" value="Go" id="saveFillUp">
		<input type="button" value="Show FillUPs" id="showFillUps">
		<input type="button" value="Get Avg MPG" id="getAverages">
		
		<!-- Divs to Display various results -->
		<div id="fillupTable"></div>
		<div id="lastStats"></div>
		<div id="avgStats"></div>

		<!-- To Edit results -->
		<div id="divEdit">
			<hr>
			<h1>Edit</h1>
			<label for="editOdo">Old Odometer </label><input type="number" name="editOdo" placeholder="123,456" id="editOdo">
			<label for="editGal">Old Gallons </label><input type="number" step="0.001" name="edittGal" placeholder="14.187" id="editGal">
			<label for="editCost">Old Cost </label><input type="number" step="0.01" name="editCost" placeholder="48.25" id="editCost">
			<label for="edittNote">Old Notes </label><input type="text" name="editNote" placeholder="Arco station" id="editNote">
			<input type="button" value="Edit" id="btnEditFillUp">
		</div>

		<!-- jQuery. Duh. -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<!-- The JavaScript database that syncs. Found at http://pouchdb.com. Related to CouchDB. -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/4.0.3/pouchdb.min.js"></script>

		<script>
		$(function() {
			"use strict";
			
			$("#divEdit").hide();
			
			var str, nStr, myLat, myLon;
			
			// Create PouchDB database
			var db = new PouchDB("gasDB00",
						function(pdberr, pdbgood) {
							if(!pdberr) {
								db.info(function(infoerr, infoinf) { 
									if(!infoerr) {
										console.log(infoinf);
									} else {
										console.log(infoerr);
									};
								});
							} else {
								console.log(pdberr);
							};
						}
			);
			
			// Function to clear user input fields
			function clearFields() {
				document.getElementById("currOdo").value = "";
				document.getElementById("currGal").value = "";
				document.getElementById("currCost").value = "";
				document.getElementById("currNote").value = "";
			};
			
			// Function to save a FillUp, gathered from user input
			function saveFillUp() {
				getLocation(); // To check the Location again
				var theOdo = document.getElementById("currOdo").value;
				var theGal = Math.round(100 * (document.getElementById("currGal").value)) / 100;
				var theCost = document.getElementById("currCost").value;
				var theNote = document.getElementById("currNote").value;
				// var theDate = new Date();					// JS Date Object
				// var theJDate = theDate.toJSON(); 		// JSON Date
				// var theSDate = theDate.toString();		// String Date
				// var theIDate = theDate.toISOString();	// ISO String Date
				var theIDate = new Date().toISOString();
				var theprettyDate;								// Human readable-ish Date
				var prettyDate = theDate.toDateString();
				var prettyHour = theDate.getHours() + ":" + ("0" + theDate.getMinutes()).slice(-2);
				theprettyDate = prettyDate + " " + prettyHour;
				
				// Create a new PouchDB Document with all the user-generated data, plus Date()
				if((theOdo == "") || (theGal == 0) || (theGal == "") || (theCost == "")) {
					console.log("BAD DATA");
					document.getElementById("avgStats").innerHTML = "<p>Please enter all fields!</p>" ;
				} else {
					var aFillup = {
						_id: theIDate,
						date: theprettyDate,
						odo: theOdo,
						gal: theGal,
						cost: theCost,
						note: theNote,
						posLat: myLat,
						posLon: myLon
					};
					
					// Put the Document into the PouchDB 
					db.put(aFillup, 
						function (fillerror, fillresult) {
							if(!fillerror) {
								clearFields();
								showFillUps();	// Display input data on-screen, in a table.
							} else { 
								console.log(fillerror);
							}
						}
					);
				};
			}; // END Function to save a FillUp
			
			// Function to edit existing FillUp --	PROBLEMS ---------
			function editFillUp(d, pd, o, g, c, n, lat, lon) {
				$("#divEdit").show();
				
				document.getElementById("editOdo").value  = o;
				document.getElementById("editGal").value   = g;
				document.getElementById("editCost").value = c;
				document.getElementById("editNote").value = n;
				
				$("#btnEditFillUp").on("click", function() {
					var newOdo 	= document.getElementById("editOdo").value;
					var newGal	= document.getElementById("editGal").value;
					var newCost	= document.getElementById("editCost").value;
					var newNote	= document.getElementById("editNote").value;
					var newLat = parseFloat(lat), newLon = parseFloat(lon);
				
					db.get(d, function callback(error, result) {
					console.log(d);
						if(error) {
							document.getElementById("editOdo").value = "";
							document.getElementById("editGal").value = "";
							document.getElementById("editCost").value = "";
							document.getElementById("editNote").value = "";
							alert("The Fill Up on " + d + " does not exist. Try again!");
							console.log(error);
							} else {
							// SOMETHING WRONGG HERE ---------
							console.log(result);

							db.put({
								_id: d,
								_rev: result._rev,
								date: pd,
								odo: newOdo,
								gal: newGal,
								cost: newCost,
								note: newNote,
								posLat: newLat,
								posLon: newLon
								}, function callback(error, result){
									if(error){ console.log("BAD:" + error); 
										document.getElementById("editOdo").value = "";
										document.getElementById("editGal").value = "";
										document.getElementById("editCost").value = "";
										document.getElementById("editNote").value = "";
									} else { 
										console.log("Good: " + result.ok)
										document.getElementById("editOdo").value = "";
										document.getElementById("editGal").value = "";
										document.getElementById("editCost").value = "";
										document.getElementById("editNote").value = "";
									}
							}); 
							showFillUps();
							getAverages();			
							}
						}
					);
				});
				
				
				
			}; // END Function to edit existing FillUp

			// Function to get all the Documents that were added to the PouchDB database
			function showFillUps() {
				db.allDocs(
					{ include_docs: true, descending: true },
					function (showerr, doc) {
						if(!showerr) {
							showTableOfFillUps(doc.rows); 	// Call the function to build the Table on-screen
							getAverages();							// Also display the latest Averages on-screen
						} else {
							console.log(showerr);
						};
					}
				);
			};
			
			// Function to build the Table and show all the data from the PouchDB database
			function showTableOfFillUps(data) {
				var div = document.getElementById("fillupTable");
				var str = "<table border='1' style='width: 100%; margin-top: 25px; table-layout: fixed;' id='tableFillups'><tr><th>Date</th><th>Odo</th><th>Gallons</th><th>Cost</th><th>Note</th><th>Coords</th></tr>";
				for(var i = 0; i < data.length; i++) {
					str += "<tr><td style='text-wrap: normal; word-wrap: break-word;' class='tableDate' data-date='" + data[i].doc._id + "' data-pdate='" + data[i].doc.date + "'>" + data[i].doc.date +
					"</td><td style='text-wrap: normal; word-wrap: break-word;' class='tableOdo' data-odo='" + data[i].doc.odo + "'>" + addCommas(data[i].doc.odo) +
					"</td><td style='text-wrap: normal; word-wrap: break-word;' class='tableGal' data-gal='" + data[i].doc.gal + "'>" + data[i].doc.gal + 
					"</td><td style='text-wrap: normal; word-wrap: break-word;' class='tableCost' data-cost='" + data[i].doc.cost + "'>$" + data[i].doc.cost + 
					"</td><td style='text-wrap: normal; word-wrap: break-word;' class='tableNote' data-note='" + data[i].doc.note + "'>" + data[i].doc.note + 
					"</td><td style='text-wrap: normal; word-wrap: break-word;'>" + "<span class='tablePos' data-lat='" + data[i].doc.posLat + "' data-lon='" + data[i].doc.posLon + "'>" + data[i].doc.posLat.toFixed(2) + ", " + data[i].doc.posLon.toFixed(2) + "</span>" +
					"</td></tr>";
				};
				str += "</table> <br>";
				div.innerHTML = str;
			};
			
			// Function to calculate Averages
			function getAverages() {
				db.allDocs(
					{ include_docs: true, ascending: true },
					function (err, doc) {
						if(!err) {
							// To get, calculate, and display Total Gallons, Average Gallons, Total Cost, and Average Cost
							var totalGal = 0;
							var avgGal = 0;
							var totalCost = 0;
							var avgCost = 0;
							
							for(var j = 0; j < doc.rows.length; j++) {
								totalGal += Number(doc.rows[j].doc.gal);
								totalCost += Number(doc.rows[j].doc.cost);
							};
							
							avgGal = Math.round(100 * (totalGal / doc.rows.length)) / 100;
							avgCost = Math.round(100 * (totalCost / doc.rows.length)) / 100;
							
							if((totalGal == 0) && (totalCost == 0)) {
								document.getElementById("avgStats").innerHTML = "<p>Please enter eat least two Fillups</p>" ;
							} else {
								document.getElementById("avgStats").innerHTML = "<p>Total Gallons: " + totalGal + "<br>Average Gallons: " + avgGal + "</p>";
								document.getElementById("avgStats").innerHTML += "Total Cost: $" + totalCost + "<br>Average Cost: $" + avgCost + "</p>";
							} // END of Total Gallons, Average Gallons, Total Cost, and Average Cost
							
							// To calculate average Miles Per Gallon from all the data input
							var lastOdo = 0;
							var lastGal = 0;
							var secondLastOdo = 0;
							var totalMPG = 0;
							var avgMPG = 0;
							
							for(var k = doc.rows.length; k > 0; k--) {
								lastOdo = Number(doc.rows[k - 1].doc.odo);
								lastGal = Number(doc.rows[k - 1].doc.gal);
								if (k > 1) {
									secondLastOdo = Number(doc.rows[k - 2].doc.odo); 
								};
								var mpg = Math.round(100 * ((lastOdo - secondLastOdo) / lastGal)) / 100;
								totalMPG += mpg;
								if (mpg > 0) {
									// ...what was this for again?
									// console.log("Last: " + lastOdo + " || secondLast: " + secondLastOdo + " || lastGal: " + lastGal + " || MPG: " + mpg);
								};
							} 
							
							avgMPG = ((totalMPG / (doc.rows.length - 1))).toFixed(2);
							
							if (avgMPG == Infinity) {
								document.getElementById("avgStats").innerHTML += "<p><strong>Average Miles Per Gallon will appear after more than two Fillups!</strong></p>";
							} else if(avgMPG == 0) {
								// Don't show Zero Average MPG
							} else {
								document.getElementById("avgStats").innerHTML += "<p><strong>Average Miles Per Gallon: " + avgMPG + "</strong></p>";
							} // END average Miles Per Gallon
						} else {
							console.log("Error getting the Documents from the database: " + err);
						};
					}
				);
			}; // END of function to calculate Averages
			
			// Function to add commas and periods to numbers. Found at http://www.mredkj.com/javascript/nfbasic.html
			function addCommas(nStr) {
				nStr += '';
				var x = nStr.split('.');
				var x1 = x[0];
				var x2 = x.length > 1 ? '.' + x[1] : '';
				var rgx = /(\d+)(\d{3})/;
				while (rgx.test(x1)) {
					x1 = x1.replace(rgx, '$1' + ',' + '$2');
				}
				return x1 + x2;
			};
			
			// Function to get user's Location
			function getLocation() {
				navigator.geolocation.getCurrentPosition(posSuccess, posError);
			};
			
			// Function to deal with Location Success
			function posSuccess(position) {
				myLat = position.coords.latitude;
				myLon = position.coords.longitude;
			};
			
			// Function to deal with Location Failure
			
			function posError(error) {
				switch(error.code) {
					case error.PERMISSION_DENIED:
						myMap.innerHTML = "User denied the request for Geolocation."
						break;
					case error.POSITION_UNAVAILABLE:
						myMap.innerHTML = "Location information is unavailable."
						break;
					case error.TIMEOUT:
						myMap.innerHTML = "The request to get user location timed out."
						break;
					case error.UNKNOWN_ERROR:
						myMap.innerHTML = "An unknown error occurred."
						break;
				}
			};
			
			
			$("#saveFillUp").on("click", function() { saveFillUp();});
			$("#showFillUps").on("click", function() { showFillUps();});
			$("#getAverages").on("click", function() { getAverages();});
			
			$("#fillupTable").on("click", "tr", function() {  
				var $editDate = $(this).find(".tableDate").attr("data-date");
				var $editPDate = $(this).find(".tableDate").attr("data-pdate");
				var $editOdo = $(this).find(".tableOdo").attr("data-odo");
				var $editGal = $(this).find(".tableGal").attr("data-gal");
				var $editCost = $(this).find(".tableCost").attr("data-cost");
				var $editNote = $(this).find(".tableNote").attr("data-note");
				var 	$editLat = $(this).find(".tablePos").attr("data-lat"),
						$editLon = $(this).find(".tablePos").attr("data-lon");
				editFillUp($editDate, $editPDate, $editOdo, $editGal, $editCost, $editNote, $editLat, $editLon);
			});
				
			getLocation(); 		// To get a base location on page load
			});
		</script>
	</body>
</html>